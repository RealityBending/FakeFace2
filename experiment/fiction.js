// Condition assignment ============================================
function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1))
        ;[array[i], array[j]] = [array[j], array[i]]
    }
    return array
}

function assignCondition(stimuli) {
    new_stimuli_list = []
    // Loop through unique categories
    for (let cat of [...new Set(stimuli.map((a) => a.Category))]) {
        // Get all stimuli of this category
        var cat_stimuli = stimuli.filter((a) => a.Category == cat)

        // Shuffle cat_stimuli
        cat_stimuli = shuffleArray(cat_stimuli) // Custom funciton defined above

        // Assign half to "Reality" condition and half to "Fiction" condition
        for (let i = 0; i < cat_stimuli.length; i++) {
            cat_stimuli[i].Condition = i < cat_stimuli.length / 2 ? "Reality" : "Fiction"
        }

        // Add to new_stimuli_list
        new_stimuli_list.push(...cat_stimuli)
    }
    return shuffleArray(new_stimuli_list)
}

// Variables ===================================================================
var fiction_trialnumber = 1
var color_cues = shuffleArray(["red", "blue", "green"])
color_cues = { Reality: color_cues[0], Fiction: color_cues[1] }
var text_cue = { Reality: "Photograph", Fiction: "AI-generated" }
stimuli = assignCondition(stimuli)

// Screens =====================================================================
var fiction_instructions1 = {
    type: jsPsychHtmlButtonResponse,
    css_classes: ["narrow-text"],
    stimulus:
        "<h1>Part 3/4</h1>" +
        "<div style='text-align: left'>" +
        "<p>This study stems out of an exciting new partnership between researchers from the <b>University of Sussex</b> and a young <b>AI startup</b> based in Brighton, UK, that specializes in making AI technology more ethical.</p>" +
        "<p>Our goal is to better understand how various people react to different faces. For this, we will be using a new <b>image-generation algorithm</b> (based on a modified <i>Generative Adversarial Network</i>) trained on a carefully refined material to produce realistic high-quality images. " +
        "This allows us to manipulate the generation parameters and understand how they impact face perception.</p>" +
        "<div style='text-align: center;'><img src='media/gan.gif' height='200'></img></div>" +
        "<p>In the next part, you will be presented with faces generated by our algorithm (preceded by the word '<b style='color:" +
        color_cues["Fiction"] +
        "'>AI-generated</b>'), intermixed with real photos (preceded by the word '<b style='color:" +
        color_cues["Reality"] +
        "'>Photograph</b>') taken from public picture databases, adjusted to be of similar dimension and aspect as the artificially-generated images.</p > " +
        "<p>The faces will be <b>briefly flashed on the screen</b>. Imagine that they belong to a real person (for example, it is the <b>profile picture</b> on someone's social media). After each image, you will be asked a series of questions:</p>" +
        '<li><b style="color: purple">Beauty</b>: To what extent do you think the face is "objectively" <b>good-looking</b> (the degree to which the face is aesthetically appealing).</li>' +
        '<li><b style="color: purple">Attractiveness</b>: To what extent do <b>you personally</b> find the person <b>attractive</b> (how drawn are you to this person).</li>' +
        '<li><b style="color: purple">Trustworthiness</b>: To what extent do you find this person <b>trustworthy</b> (reliable, honest, responsible etc.,).</li>' +
        "<p>Note that we are interested in your <b>first impression</b>, so please respond according to your gut feelings.</p>" +
        "<p>Below is an example of how the questions will appear after each image:</p>" +
        "<div style='text-align: center;'><img src='media/scales_phase1.png' height='400' style='border:5px solid #D3D3D3; padding:3px; margin:5px'></img></div>" +
        "<p style='text-align: center';>Press start once you are ready.</p>",
    choices: ["Start"],
    data: { screen: "fiction_instructions1" },
}

var fiction_instructions2 = {
    type: jsPsychHtmlButtonResponse,
    css_classes: ["narrow-text"],
    stimulus:
        "<h1>Part 4/4</h1>" +
        "<div style='text-align: left'>" +
        "<img src='media/phase2_img.png' height='300' align='right'></img>" +
        "<p>Thank you! In this final phase, we would like to see if you found our <b>image generation algorithm convincing</b> and error-free.</p>" +
        "<p>But there is <b>something important</b> we need to tell you... In the previous phase, some images were <b style='color: orange'>intentionally mislabelled</b> (we told you it was a photograph when it was actually AI-generated and vice versa).</p>" +
        "<p>In this phase, we want you to tell us for each image <b>what you think is the true category</b>! " +
        "We will briefly present all the images once more, and your task is to tell us if you think the image is AI-generated or a photograph. Indicate your degree of <b>confidence</b> and certainty by selecting larger numbers.</p>" +
        "<div style='text-align: center;'><img src='media/scales_phase2.png' height='170' style='border:5px solid #D3D3D3; padding:3px; margin:5px'></img></div>" +
        "<p style='text-align: center';>Press start once you are ready.</p>",
    choices: ["Start"],
    data: { screen: "fiction_instructions2" },
}

var fiction_preloadstims = {
    type: jsPsychPreload,
    images: stimuli.map((a) => "stimuli/AMFD/" + a.stimulus),
}

var fiction_fixation1 = {
    type: jsPsychHtmlKeyboardResponse,
    // on_start: function () {
    //     document.body.style.cursor = "none"
    // },
    stimulus:
        "<div  style='font-size:500%; position:fixed; text-align: center; top:50%; bottom:50%; right:20%; left:20%'>+</div>",
    choices: ["s"],
    trial_duration: 500,
    save_trial_parameters: { trial_duration: true },
    data: { screen: "fiction_fixation1" },
}

var fiction_cue = {
    type: jsPsychHtmlKeyboardResponse,
    stimulus: function () {
        var cond = jsPsych.timelineVariable("Condition")
        return (
            "<div style='font-size:450%; position:fixed; text-align: center; top:50%; bottom:50%; right:20%; left:20%; color: " +
            color_cues[cond] +
            "'><b>" +
            text_cue[cond] +
            "</b></div>"
        )
    },
    data: function () {
        var cond = jsPsych.timelineVariable("Condition")
        return {
            screen: "fiction_cue",
            color: color_cues[cond],
            text: cond,
        }
    },
    choices: ["s"],
    trial_duration: 1000,
    save_trial_parameters: { trial_duration: true },
}

var fiction_showimage1 = {
    type: jsPsychImageKeyboardResponse,
    stimulus: function () {
        return "stimuli/AMFD/" + jsPsych.timelineVariable("stimulus")
    },
    stimulus_height: function () {
        if (window.innerHeight < window.innerWidth) {
            return Math.round(0.9 * window.innerHeight)
        } else {
            return null
        }
    },
    stimulus_width: function () {
        if (window.innerHeight > window.innerWidth) {
            return Math.round(0.9 * window.innerWidth)
        } else {
            return null
        }
    },
    trial_duration: 2000,
    choices: ["s"],
    save_trial_parameters: { trial_duration: true },
    data: { screen: "fiction_image1" },
    on_finish: function (data) {
        data.trial_number = fiction_trialnumber
        fiction_trialnumber += 1
        window_width = window.innerWidth
        window_height = window.innerHeight
    },
    // Enable webgazer
    extensions: [
        {
            type: jsPsychExtensionWebgazer,
            params: { targets: ["#jspsych-image-keyboard-response-stimulus"] },
        },
    ],
}

// Oosterhof and Todorov (2008) - 9 point scale (Not at all to Extremely) TRAIT VARIABLES
var fiction_ratings1 = {
    type: jsPsychSurvey,
    survey_json: {
        goNextPageAutomatic: true,
        showQuestionNumbers: false,
        showNavigationButtons: false,
        title: "Rating",
        description: "Think of the person that you just saw.",
        pages: [
            {
                elements: [
                    {
                        type: "rating",
                        name: "Beauty",
                        title: "This face is beautiful",
                        isRequired: true,
                        rateMin: -3,
                        rateMax: 3,
                        minRateDescription: "Disagree",
                        maxRateDescription: "Agree",
                        displayMode: "buttons",
                    },
                    {
                        type: "rating",
                        name: "Attractiveness",
                        title: "I found this person attractive",
                        isRequired: true,
                        rateMin: -3,
                        rateMax: 3,
                        minRateDescription: "Disagree",
                        maxRateDescription: "Agree",
                        displayMode: "buttons",
                    },
                    {
                        type: "rating",
                        name: "Trustworthiness",
                        title: "I found this person trustworthy",
                        isRequired: true,
                        rateMin: -3,
                        rateMax: 3,
                        minRateDescription: "Disagree",
                        maxRateDescription: "Agree",
                        displayMode: "buttons",
                    },
                    // "This face is conventionally beautiful",
                    // "Would you find this person approachable?",
                    // "This person reminds me of someone I know", // Familiarity (van vugt et al., 2010)
                    // "How much does this face look like yours?",
                    // "How weird is the face you saw?",   // include eeriness as well? (cf uncanny valley effect)
                    // "How dominant is the face you saw?",
                    // "How musculine/feminine is the face you saw?",
                    // "How emotionally stable is the face you saw?",
                    // "How mean is the face you saw?",
                    // "How boring is the face you saw?",
                    // "How intelligent is the face you saw?",
                    // "How caring is the face you saw?",
                    // "How egoistic is the face you saw?",
                    // "How responsible is the face you saw?",
                ],
            },
        ],
    },
    data: {
        screen: "fiction_ratings1",
    },
}

var fiction_phase1 = {
    timeline_variables: stimuli, //.slice(0, 3), // TODO: remove this
    timeline: [
        fiction_fixation1,
        fiction_cue,
        fiction_fixation1,
        fiction_showimage1,
        fiction_ratings1,
    ],
}

// Stage 2 loops and variables

var fiction_fixation2 = {
    type: jsPsychHtmlKeyboardResponse,
    // on_start: function () {
    //     document.body.style.cursor = "none"
    // },
    stimulus:
        "<div  style='font-size:500%; position:fixed; text-align: center; top:50%; bottom:50%; right:20%; left:20%'>+</div>",
    choices: ["s"],
    trial_duration: 500,
    save_trial_parameters: { trial_duration: true },
    data: { screen: "fiction_fixation2" },
}

var fiction_showimage2 = {
    type: jsPsychImageKeyboardResponse,
    stimulus: function () {
        return "stimuli/AMFD/" + jsPsych.timelineVariable("stimulus")
    },
    stimulus_height: function () {
        if (window.innerHeight < window.innerWidth) {
            return Math.round(0.9 * window.innerHeight)
        } else {
            return null
        }
    },
    stimulus_width: function () {
        if (window.innerHeight > window.innerWidth) {
            return Math.round(0.9 * window.innerWidth)
        } else {
            return null
        }
    },
    trial_duration: 1000,
    choices: ["s"],
    save_trial_parameters: { trial_duration: true },
    data: { screen: "fiction_image2" },
    on_finish: function (data) {
        data.trial_number = fiction_trialnumber
        fiction_trialnumber += 1
    },
}

var fiction_ratings2 = {
    type: jsPsychSurvey,
    survey_json: {
        goNextPageAutomatic: true,
        showQuestionNumbers: false,
        showNavigationButtons: false,
        pages: [
            {
                elements: [
                    {
                        type: "rating",
                        name: "Realness",
                        title: "I think this face is...",
                        description: "Indicate your confidence that the image is fake or real",
                        isRequired: true,
                        // rateValues: [
                        //     {
                        //         value: -1,
                        //         text: "-4",
                        //     },
                        //     {
                        //         value: -0.75,
                        //         text: "-3",
                        //     },
                        //     {
                        //         value: -0.5, // 1/2
                        //         text: "-2",
                        //     },
                        //     {
                        //         value: -0.25, // 1/4
                        //         text: "-1",
                        //     },
                        //     // {
                        //     //     value: 0,
                        //     //     text: "0",
                        //     // },
                        //     {
                        //         value: 0.25, // 1/4
                        //         text: "1",
                        //     },
                        //     {
                        //         value: 0.5, // 1/2
                        //         text: "2",
                        //     },
                        //     {
                        //         value: 0.75, // 3/4
                        //         text: "3",
                        //     },
                        //     {
                        //         value: 1,
                        //         text: "4", // "4 (100% Certain)",
                        //     },
                        // ],
                        rateMin: -3,
                        rateMax: 3,
                        minRateDescription: "AI-Generated",
                        maxRateDescription: "Photograph",
                        displayMode: "buttons",
                    },
                ],
            },
        ],
    },
    data: {
        screen: "fiction_ratings2",
    },
}

var fiction_phase2 = {
    timeline_variables: shuffleArray(stimuli), // .slice(0, 3) TODO: remove this
    timeline: [fiction_fixation2, fiction_showimage2, fiction_ratings2],
}

// Feedback ====================================================================

var fiction_feedback1 = {
    type: jsPsychSurvey,
    survey_json: {
        title: "Thank you!",
        description: "Before we start the second phase, we wanted to know your thoughts.",
        showQuestionNumbers: false,
        elements: [
            {
                type: "checkbox",
                name: "Feedback_1",
                title: "Face Attractiveness",
                description: "Please select all that apply",
                choices: [
                    "Some faces were really attractive",
                    "No face was particularly attractive",
                    "AI-generated images were more attractive than the photos",
                    "AI-generated images were less attractive than the photos",
                ],
                showOtherItem: true,
                showSelectAllItem: false,
                showNoneItem: false,
            },
            {
                type: "checkbox",
                name: "Feedback_2",
                title: "AI-Generation Algorithm",
                description: "Please select all that apply",
                choices: [
                    "The difference between the photos and the AI-generated images was obvious",
                    "The difference between the photos and the AI-generated images was subtle",
                    "I didn't see any difference between photos and AI-generated images",
                    "I felt like the labels ('Photograph' and 'AI-Generated') were not always correct",
                    "I felt like the labels were reversed (e.g., 'Photograph' for AI-generated images and vice versa)",
                    "I feel like all the images were photos",
                    "I feel like all the images were AI-generated",
                ],
                showOtherItem: true,
                showSelectAllItem: false,
                showNoneItem: false,
            },
            {
                visibleIf: "{Feedback_2} anyof ['I feel like all the images were photos']",
                title: "How certain are you that all images were photos?",
                name: "Feedback_2_ConfidenceReal",
                type: "rating",
                rateMin: 0,
                rateMax: 5,
                minRateDescription: "Not at all",
                maxRateDescription: "Completely certain",
            },
            {
                visibleIf: "{Feedback_2} anyof ['I feel like all the images were AI-generated']",
                title: "How certain are you that all images were AI-generated?",
                name: "Feedback_2_ConfidenceFake",
                type: "rating",
                rateMin: 0,
                rateMax: 5,
                minRateDescription: "Not at all",
                maxRateDescription: "Completely certain",
            },
        ],
    },
    data: {
        screen: "fiction_feedback1",
    },
}
